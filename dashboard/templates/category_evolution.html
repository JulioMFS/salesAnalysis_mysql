<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Category Evolution</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

<style>
    /* Inputs, dropdowns, multi-select */
    #date_range,
    #view,
    #categories {
        font-size: 0.7rem;
    }

    /* Labels and buttons */
    .form-label { font-size: 0.65rem; }
    .btn { font-size: 0.65rem; padding: 0.25rem 0.5rem; }

    /* Flatpickr calendar */
    .flatpickr-calendar { font-size: 0.7rem; }
    .flatpickr-day { line-height: 1.2; font-size: 0.7rem; }
    .flatpickr-monthDropdown-months,
    .flatpickr-current-month span.cur-month,
    .flatpickr-weekday { font-size: 0.7rem; }

    /* Card & spacing */
    .card { padding: 0.8rem; }
    .row.g-2 > * { margin-bottom: 0.3rem; }
</style>


</head>
<body>

<div class="container my-3">

    <div class="d-flex align-items-center mb-3">
        <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary me-2">‚Üê Back</a>
        <h3 class="mb-0 flex-grow-1 text-center">Expense Category Evolution</h3>
        <a href="/" class="btn btn-sm btn-dark ms-2">üè† Dashboard</a>
    </div>

    <div class="card shadow-sm">
        <form id="evolutionForm" class="mb-3">

            <div class="row g-2 mb-2">
                <!-- Start Date -->
               <div class="col-md-3 col-sm-6">
                    <label for="date_range" class="form-label">Date range</label>
                    <!-- visible input for range -->
                    <input
                        type="text"
                        id="date_range"
                        class="form-control form-control-sm"
                        placeholder="Select period"
                        required
                    >
                    <!-- hidden fields sent to backend -->
                    <input type="hidden" id="start_date" name="start_date">
                    <input type="hidden" id="end_date" name="end_date">
               </div>

                <!-- View -->
                <div class="col-md-3 col-sm-6">
                    <label for="view" class="form-label">View</label>
                    <select name="view" id="view" class="form-select form-select-sm">
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="daily">Daily</option>
                    </select>
                </div>

                <!-- Categories -->
                <div class="col-md-3 col-sm-6">
                    <label for="categories" class="form-label">Categories</label>
                    <select name="categories[]" id="categories" multiple size="3" class="form-select form-select-sm">
                        {% for c in categories %}
                        <option value="{{ c }}">{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Presets -->
            <div class="mb-2">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="7d">Last 7 days</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="last_month">Last month</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-preset="ytd">YTD</button>
                </div>
            </div>

            <!-- Actions -->
            <div class="mb-2">
                <button type="submit" class="btn btn-primary btn-sm me-1">Analyze</button>
                <button id="toggleBarMode" class="btn btn-secondary btn-sm" type="button">Stacked view</button>
            </div>

        </form>

        <div id="chart"></div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="{{ url_for('static', filename='js/category_evolution.js') }}" nonce="{{ csp_nonce }}"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const rangeInput = document.getElementById("date_range");
    const startInput = document.getElementById("start_date");
    const endInput = document.getElementById("end_date");
    const viewSelect = document.getElementById("view");

    const toISO = d => d.toISOString().split("T")[0];

    let fp; // flatpickr instance

    function initPicker() {
        if (fp) fp.destroy(); // destroy previous picker

        if (viewSelect.value === "monthly") {
            fp = flatpickr(rangeInput, {
                plugins: [new monthSelectPlugin({
                    shorthand: true,
                    dateFormat: "Y-m",
                    altFormat: "F Y",
                })],
                mode: "range",
                onChange: (dates) => {
                    if (dates.length === 2) {
                        const start = new Date(dates[0].getFullYear(), dates[0].getMonth(), 1);
                        const end = new Date(dates[1].getFullYear(), dates[1].getMonth() + 1, 0);
                        startInput.value = toISO(start);
                        endInput.value = toISO(end);
                    }
                },
            });
        } else if (viewSelect.value === "weekly") {
            fp = flatpickr(rangeInput, {
                mode: "range",
                dateFormat: "Y-m-d",
                onChange: (dates) => {
                    if (dates.length === 2) {
                        const start = startOfWeek(dates[0]);
                        const end = endOfWeek(dates[1]);
                        startInput.value = toISO(start);
                        endInput.value = toISO(end);
                    }
                },
            });
        } else {
            fp = flatpickr(rangeInput, {
                mode: "range",
                dateFormat: "Y-m-d",
                onChange: (dates) => {
                    if (dates.length === 2) {
                        startInput.value = toISO(dates[0]);
                        endInput.value = toISO(dates[1]);
                    }
                },
            });
        }
    }

    function startOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay() || 7;
        d.setDate(d.getDate() - day + 1);
        return d;
    }

    function endOfWeek(date) {
        const d = startOfWeek(date);
        d.setDate(d.getDate() + 6);
        return d;
    }

    viewSelect.addEventListener("change", initPicker);
    initPicker();
});
</script>

</body>
</html>
